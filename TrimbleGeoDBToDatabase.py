import getpass
import datetime  
    

# Input parameters
# GeoDB = arcpy.GetParameterAsText(0) # The input geodatabase (Workspace)
GeoDB = "C:/Work/VitalSigns/ARCN-CAKN Shallow Lakes/Local/2020-07 Geodatabase/2020/YUCH_2020/YUCH_2020_Deployment.gdb"
# print(GeoDB)

# set the workspace
arcpy.env.workspace = GeoDB

# Use the ListFeatureClasses function to return a list of
#  shapefiles.
#featureclasses = arcpy.ListFeatureClasses()
SourceFilename = os.path.basename(GeoDB) # Gets the filename from the path from above.
username = getpass.getuser()
HeaderInfo = "-- NPS Arctic and Central Alaska Inventory and Monitoring Program, Shallow Lakes Monitoring\n-- Field data import script generated by " + username + " on " + str(datetime.datetime.now())  + ".\n-- Source geodatabase: " + GeoDB + "\n\nUSE AK_ShallowLakes\nBEGIN TRANSACTION -- COMMIT  ROLLBACK\n"

# Translates the data in the Depth_Joined featureclass into a script of SQL insert queries that can be executed on the AK_ShallowLakes database.
def Export_Depth_Joined():
    try:
        FeatureClass = "Depth_Joined"

        # This will be the output CSV file
        CSVFile = os.path.dirname(arcpy.env.workspace) + '/' + FeatureClass + '_Insert.sql'
        
        # if the CSV file exists already then delete it 
        if os.path.exists(CSVFile):
            arcpy.AddMessage("File exists: " + CSVFile + '. Deleted')
            os.remove(CSVFile)
        CSVFile = open(CSVFile,'a')  

        SqlPrefix = 'INSERT INTO tblPondDepths(PONDNAME,SAMPLEDATE,GPS_TIME,LATITUDE,LONGITUDE,DEPTH,COMMENTS_DEPTHS,DATAFILE,SOURCE) VALUES('
        Fields = arcpy.ListFields(FeatureClass)
        Field_names =  [Field.name for Field in Fields]

        #print("-- Field data import script generated on " + str(date.today()) + " by " 
        CSVFile.write(HeaderInfo)

        # loop through the data rows and output to CSV
        for row in arcpy.da.SearchCursor(FeatureClass,Field_names):
            i = 0
            PondName = str(row[10])
            SampleDate = str(row[7])
            GPS_Time = str(row[7])
            Latitude = str(row[9])
            Longitude = str(row[8])
            Depth = str(row[4])
            Comments_Depths = str(row[5])
            DataFile = SourceFilename
            Source = SourceFilename

            CSVFile.write(SqlPrefix + "'" + PondName + "','" + SampleDate + "','" + GPS_Time + "'," + Latitude + "," + Longitude + "," + Depth + ",'" + Comments_Depths + "','" + DataFile + "','" + Source + "');\n")
            
        CSVFile.write("\n-- COMMIT\n-- ROLLBACK")
        FinishedMessage = FeatureClass + " data written to " + CSVFile.name.replace("/","\\")
        print(FinishedMessage)
        arcpy.AddMessage(FinishedMessage)

    except expression as identifier:
        error = 'Error: ' + FeatureClass + ' ' + str(e)
        arcpy.AddMessage(error)
        print(error)

# start here
Export_Depth_Joined()